syntax = 'proto3';

package bestowcode.coresdk.persistence.v1;

import 'google/protobuf/any.proto';
import 'google/protobuf/timestamp.proto';
import 'google/protobuf/dart_options.proto';
import 'bestowcode/coresdk/options/core_sdk_options.proto';

option (dart_options.imports) = {mixins: {import_from: 'package:core_proto/google/protobuf/timestamp.pb.dart', name: 'Timestamp'}};
service PersistenceLocalService {
  option (bestowcode.coresdk.options.service_api) = true;
  rpc Persist(PersistRequest) returns(PersistResponse);
  rpc GetHead(GetHeadRequest) returns  (stream GetHeadResponse);
  //  rpc getEntries(stream GetEntriesRequest) returns stream (GetEntriesResponse);
  //  rpc getEvents(stream GetEventsRequest) returns stream (GetEventsResponse);
  //  rpc getStateRefs(GetStateRefsRequest) returns (GetStateRefsResponse);

}
message GetHeadRequest {}
message GetHeadResponse {}


message PersistResponse {}
message PersistRequest {
  message Batch {
    oneof action {
      int32 start_id = 1;
      int32 stop_id = 2;
    }
  }
  message AddHead {
    string ref_name = 1;
    string value = 2;
    string previous = 3;
    int32 sequence_number = 4;
    google.protobuf.Timestamp created_at = 5;
  }
  message PutEntry {
    string transaction_id = 1;
    string ref = 2;
    google.protobuf.Timestamp created_at = 4 ;
    message EntryInitial {}
    message EntryEvent {
      google.protobuf.Any proto_data = 1;
    }
    message EntryMerge {}
    oneof entry {
      EntryInitial initial = 10;
      EntryEvent event = 11;
      EntryMerge merge = 12;
    }
  }
  oneof body {
    Batch batch = 1;
    AddHead add_head = 2;
    PutEntry put_entry = 3;
  }
}
